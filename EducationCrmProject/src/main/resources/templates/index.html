<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Smart Programming</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>
<body>

<!-- Header -->
<div th:if="${sessionUser == null}">
    <div th:replace="~{fragments/header :: crm-header}"></div>
</div>
<div th:unless="${sessionUser == null}">
    <div th:replace="~{fragments/user-header :: u-header}"></div>
</div>
<!-- Header Ends -->

<!-- Banner -->
<main class="container-fluid">
    <section>
        <img src="/images/banner.jpg" alt="Smart Programming Banner" width="100%"/>
    </section>

    <!-- Content -->
    <section class="container py-5 bg-light">
        <h3 class="text-center mb-4">Our Courses</h3>
        
        <div class="row g-4">
            <!-- Loop through courses -->
            <div th:each="course : ${coursesList}" class="col-lg-3 col-md-6">
                <div class="card h-100" style="width: 18rem;">
                    
                    <!-- Course image -->
                    <img th:src="${course.imageUrl}" class="card-img-top" alt="Course Image">

                    <div class="card-body">
                        <!-- Course name -->
                        <h5 class="card-title" th:text="${course.name}">Course Name</h5>

                        <!-- Description -->
                        <p class="card-text" th:text="${course.description}"n>Default descriptio</p>

                        <!-- Price -->
                        <p>
                            <strong>Price :</strong>
                            <del>Rs. <span th:text="${course.originalPrice}"></span></del>
                            <span class="fw-bold text-success ms-2" th:text="${course.discountedPrice}"></span>
                        </p>

                        <!-- Buy/Login buttons -->
                        <div th:if="${sessionUser == null}">
                            <a href="login" class="btn btn-outline-primary">Login to Buy</a>
                        </div>
                        <div th:unless="${sessionUser == null}">
                            <button class="btn btn-primary"
                                th:data-cname="${course.name}"
                                th:data-camount="${course.discountedPrice}"
                                th:data-uname="${sessionUser.name}"
                                th:data-uemail="${sessionUser.email}"
                                th:data-uphoneno="${sessionUser.phoneno}"
                                onclick="purchaseCourse(this.getAttribute('data-cname'), this.getAttribute('data-camount'), this.getAttribute('data-uname'), this.getAttribute('data-uemail'), this.getAttribute('data-uphoneno'))">
                                Buy
                            </button>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="card-footer text-body-secondary">
                        <span th:text="${course.updatedon}">2 days ago</span>
                    </div>
                </div>
            </div>
            <!-- End loop -->
        </div>
    </section>
</main>

<!-- Footer -->
<div th:replace="~{fragments/footer :: crm-footer}"></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
    function purchaseCourse(courseName, courseAmount, uname, uemail, uphoneno) {
        if (!courseName || !courseAmount || !uname || !uemail || !uphoneno) {
            alert("Missing required information.");
            return;
        }

        var options = {
            "key": "rzp_test_cACwr3o2N09gz1",  // Replace with your Razorpay key
            "amount": parseInt(courseAmount) * 100, // Amount in paise
            "currency": "INR",
            "name": "Smart Programming",
            "description": "Course Transaction",
            "image": "https://i.pinimg.com/280x280_RS/6a/d0/90/6ad0908bbb78292d3b085dfd9469343d.jpg",
            "handler": function (response) {
                console.log(response);
                alert("Payment Successful. Payment ID: " + response.razorpay_payment_id);
                
                var requestData = {
                		
                		courseName: courseName,
                		courseAmount: courseAmount,
                		userEmail: uemail,
                		dateOfPurchase: new Date().toLocaleString(),
                		rzpPaymentid: response.razorpay_payment_id
                };
                
              $.ajax({
            	  type:"POST",
            	  url:"/api/storeOrderDetails",
            	  contentType: "application/json",
            	  data: JSON.stringify(requestData),
            	  success: function(response){
            		  console.log("data stored successfully", response);
            		  alert("Congrtz, course has been provided, Thank you")
            		  window.location.href= '/myCourses';
            	  },
            	  error:function(error){
            		  console.log("Error :"+error)
            		  alert("Some error occured :"+error);
            	  }
            	  
              });  
            },
            "prefill": {
                "name": uname,
                "email": uemail,
                "contact": uphoneno
            },
            "notes": {
                "courseName": courseName
            },
            "theme": {
                "color": "#3399cc"
            }
        };

        var rzp1 = new Razorpay(options);
        rzp1.on('payment.failed', function (response) {
            console.log(response);
            alert("Payment failed: " + response.error.description);
        });

        rzp1.open();
    }
</script>

</body>
</html>
